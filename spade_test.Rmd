---
title: "spade_test"
author: "haoeric"
date: "Thursday, September 11, 2014"
output: html_document
---

### 1. get the path of the simulation fcs data from SPADE package, and read the data using "flowCore" package
       
```{r}
fcs_file_path = system.file(file.path("extdata","SimulatedRawData.fcs"), 
                             package = "spade")

library(flowCore)
## read the fcs data
fcs_data <- suppressWarnings(read.FCS(fcs_file_path))
```

Play with the *.fcs* data, look into the special *flowFrame* class of the `imput_file`. 

```{r}
class(fcs_data)
mode(fcs_data)
summary(fcs_data)
str(fcs_data)

```

We see this *flowFrame* class file has 3 slots. **@exprs** **@parameters** and **@ description**. 
```{r}
class(fcs_data@exprs)
class(fcs_data@description)
class(fcs_data@parameters)
```
      
We find a new data class, "AnnotatedDataFrame", let's look into it:
```{r}
str(fcs_data@parameters)
pData(parameters(fcs_data))

# check the channel labels:
colnames(fcs_data)
# check the expression values measured for each cell and see the dead lines
fcs_exp <- exprs(fcs_data)
head(fcs_exp)
```
       
### 2 transform and plot the data
take a first look at the data using scatter plot:
```{r}
library(flowViz)
print(splom(fcs_data@exprs))

```

The data seems skewed, we do the transformation using **arcsinh** tranformation and plot again:
```{r}
tData <- transform(fcs_data, transformList(colnames(fcs_data), asinh))
print(splom(tData))

## or in a simple way
plot(transform("marker1"=asinh, "marker2"=asinh) %on% fcs_data)
```
      
### 3 data quality asseeement




### test the SPADE driver function
```{r}
output_dir <- getwd()
transforms <- c('marker1' = flowCore::arcsinhTransform(a = 0, b = 0.2), 'marker2' = flowCore::arcsinhTransform(a = 0, b = 0.2))
SPADE.driver(fcs_file_path, out_dir=output_dir, transforms=transforms, cluster_cols=c("marker1","marker2"))

## see the ouput files
grep("^libloc",dir(output_dir),invert=TRUE,value=TRUE)

## save the graph
library(igraph)
mst_graph <- igraph:::read.graph(paste(output_dir,"mst.gml",sep=.Platform$file.sep),format="gml")
layout <- read.table(paste(output_dir,"layout.table",sep=.Platform$file.sep))
SPADE.plot.trees(mst_graph, output_dir, out_dir=paste(output_dir,"pdf",sep=.Platform$file.sep), layout=as.matrix(layout))
```















